<!DOCTYPE html>
<html lang="id">

<head>
    
    <meta charset="UTF-8" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Loading Formulir Feedback...</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            position: relative;
            overflow-x: hidden;
        }

        .floating-icons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        /* (CSS Animasi Ikon Latar Belakang) */
        .icon-float {
            position: absolute;
            color: rgba(59, 130, 246, 0.4);
            animation: floatIcon 15s infinite ease-in-out;
            filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.2));
        }

        .icon-float:nth-child(1) { top: 10%; left: 10%; font-size: 70px; animation-delay: 0s; animation-duration: 12s; }
        .icon-float:nth-child(2) { top: 20%; left: 85%; font-size: 65px; animation-delay: 2s; animation-duration: 14s; }
        .icon-float:nth-child(3) { top: 70%; left: 15%; font-size: 60px; animation-delay: 4s; animation-duration: 13s; }
        .icon-float:nth-child(4) { top: 40%; left: 75%; font-size: 75px; animation-delay: 1s; animation-duration: 16s; }
        .icon-float:nth-child(5) { top: 60%; left: 50%; font-size: 68px; animation-delay: 5s; animation-duration: 15s; }
        .icon-float:nth-child(6) { top: 85%; left: 80%; font-size: 72px; animation-delay: 3s; animation-duration: 14s; }
        .icon-float:nth-child(7) { top: 15%; left: 45%; font-size: 58px; animation-delay: 6s; animation-duration: 11s; }

        @keyframes floatIcon {
            0% { transform: translateY(0) translateX(0) rotate(0deg) scale(1); opacity: 0.3; }
            25% { transform: translateY(-120px) translateX(80px) rotate(90deg) scale(1.1); opacity: 0.5; }
            50% { transform: translateY(-80px) translateX(-60px) rotate(180deg) scale(0.9); opacity: 0.4; }
            75% { transform: translateY(-150px) translateX(50px) rotate(270deg) scale(1.05); opacity: 0.45; }
            100% { transform: translateY(0) translateX(0) rotate(360deg) scale(1); opacity: 0.3; }
        }

        .btn-gradient {
            background-image: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(30, 64, 175, 0.2);
        }

        .btn-submit-hover:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 8px 15px rgba(30, 64, 175, 0.4);
        }

        .form-input {
            transition: all 0.2s;
            border-color: #d1d5db;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #form-container {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        #form-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
        }

        .field-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid transparent;
        }

        .field-card:hover {
            transform: translateX(4px);
            border-left: 5px solid #3b82f6;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }

        .required-label .label-text::after {
            content: "*";
            color: #ef4444;
            margin-left: 4px;
        }

        .form-banner {
            max-height: 250px;
            object-fit: cover;
            width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .option-item {
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .option-item:hover {
            background-color: #f3f4f6;
            border-color: #3b82f6;
        }

        .option-item input[type="radio"]:checked+label,
        .option-item input[type="checkbox"]:checked+label {
            font-weight: 600;
            color: #1e40af;
        }

        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            appearance: none;
            position: absolute;
            opacity: 0;
        }

        .custom-check {
            width: 1rem;
            height: 1rem;
            border: 2px solid #9ca3af;
            border-radius: 50%;
            margin-right: 0.75rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .option-item input[type="checkbox"]+.flex .custom-check { border-radius: 0.25rem; }
        .option-item input:checked+.flex .custom-check { background-color: #3b82f6; border-color: #3b82f6; }
        .option-item input:checked+.flex .custom-check:after { content: ''; width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%; }

        .option-item input[type="checkbox"]:checked+.flex .custom-check:after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.5rem; color: white; background: none; border-radius: 0;
        }

        /* --- STYLE BARU UNTUK RATING --- */
        .rating-star {
            font-size: 2.25rem;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
        }
        .rating-star:hover { transform: scale(1.1); color: #f59e0b; }
        .rating-star.active { color: #fbbf24; }
    </style>
</head>

<body>
    
        <div class="floating-icons">
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                </div>
            
                <div class="icon-float">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="1em" height="1em">
                        <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z" />
                    </svg>
                </div>
            </div>

            <main class="py-8 md:py-16 px-4" style="position: relative; z-index: 1;">
                <div class="max-w-4xl mx-auto">
                    <div id="form-container"
                        class="bg-white p-6 md:p-10 rounded-2xl shadow-xl border-t-8 border-blue-500">
                        
                                <div id="loading-state" class="text-center py-20">
                                    <div class="spinner mx-auto mb-4"
                                style="border-color: rgba(59, 130, 246, 0.3); border-top-color: #3b82f6;"></div>
                                    <p class="text-gray-600 font-medium">Memuat Formulir...</p>
                                </div>

                                <form id="publicForm" class="hidden space-y-6" onsubmit="handleSubmission(event)">

                            <div id="banner-container" class="rounded-xl overflow-hidden shadow-lg hidden">
                                <img id="form-banner" src="" alt="Form Banner" class="form-banner">
                            </div>

                                    <div class="border-b pb-2 mb-4">
                                        <h1 id="form-title" class="text-3xl font-bold text-gray-800"></h1>
                                        <p id="form-description" class="text-gray-600 mt-1"></p>
                                    </div>

                                    <div id="form-fields" class="space-y-6"></div>

                                    <div class="pt-6">
                                        <button type="submit" id="submitBtn"
                                class="btn-gradient w-full flex items-center justify-center text-white font-semibold py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 btn-submit-hover">
                                            Kirim Feedback
                                        </button>
                                    </div>
                                
                                </form>

                                <div id="statusMessage" class="hidden p-6 rounded-xl text-center"></div>
                    </div>

                        <p class="text-center text-xs text-gray-500 mt-8">
                            Powered by ASPIRA - PT Perta Arun Gas
                        </p>
                    </div>
            </main>

        
    <script>
        // --- KONSTANTA & VARIABEL ---
        const API_BASE_URL = 'http://localhost/aspira/api.php';
        const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook-test/csr-notifier'; 

        let formStructure = null; // Menyimpan struktur form yang dimuat

        document.addEventListener('DOMContentLoaded', () => {
            const formId = getQueryParam('id');
            if (formId) {
                fetchFormStructure(formId);
            } else {
                displayStatus('Form ID tidak ditemukan. Tautan mungkin rusak.', true);
            }
        });

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // --- UTILITY UNTUK MENAMPILKAN STATUS/ERROR ---
        function displayStatus(message, isError) {
            const statusBox = document.getElementById('statusMessage');
            statusBox.innerHTML = message;
            statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            statusBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-800' : 'text-green-800');
            document.getElementById('publicForm').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            statusBox.classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function fetchFormStructure(formId) {
            try {
                const response = await fetch(`${API_BASE_URL}?action=get_form_structure&id=${formId}`);
                const result = await response.json();

                if (response.ok && result.success && result.form) {
                    formStructure = result.form;
                    renderForm(formStructure, formId);
                } else {
                    displayStatus(result.message || 'Gagal memuat formulir. Form tidak ditemukan.', true);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                displayStatus('Terjadi kesalahan server saat memuat formulir. Pastikan API PHP sudah berjalan.', true);
            }
        }

        function renderForm(form, formId) {
            document.getElementById('loading-state').classList.add('hidden');
            const publicForm = document.getElementById('publicForm');
            const formFieldsContainer = document.getElementById('form-fields');
            const bannerContainer = document.getElementById('banner-container');
            const bannerImage = document.getElementById('form-banner');

            document.getElementById('page-title').textContent = form.title;
            document.getElementById('form-title').textContent = form.title;
            document.getElementById('form-description').textContent = form.description;
            publicForm.setAttribute('data-form-id', formId);

            // Render Banner
            if (form.banner_url) {
                bannerImage.src = form.banner_url;
                bannerContainer.classList.remove('hidden');
                const formTitleDiv = document.querySelector('#publicForm > div:nth-child(2)');
                publicForm.insertBefore(bannerContainer, formTitleDiv);
            } else {
                bannerContainer.classList.add('hidden');
            }

            formFieldsContainer.innerHTML = '';

            form.fields.forEach(field => {
                const requiredClass = field.required ? 'required-label' : '';
                let fieldHtml = '';
                const labelHtml = `<label for="${field.id}" class="block text-sm font-medium text-gray-700 mb-2 ${requiredClass}"><span class="label-text">${field.label}</span></label>`;

                // Normalisasi tipe field (lowercase dan trim)
                const fieldType = field.type.toLowerCase().trim();

                switch (fieldType) {
                    case 'text':
                    case 'number':
                        fieldHtml = `${labelHtml}
                    <input type="${fieldType}" id="${field.id}" name="${field.id}" 
                    placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} 
                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-xl text-sm">`;
                        break;

                    case 'textarea':
                        fieldHtml = `${labelHtml}
                    <textarea id="${field.id}" name="${field.id}" rows="4" 
                    placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} 
                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-xl resize-none text-sm"></textarea>`;
                        break;

                    // --- CASE BARU: RATING ---
                    case 'rating':
                        fieldHtml = `
                            ${labelHtml}
                            <div class="flex items-center space-x-3 py-2" id="rating-container-${field.id}">
                                <input type="hidden" name="${field.id}" id="rating-input-${field.id}" ${field.required ? 'required' : ''}>
                                <div class="flex space-x-1">
                                    ${[1, 2, 3, 4, 5].map(n => `
                                        <i class="fas fa-star rating-star" 
                                           data-value="${n}" 
                                           onclick="setRatingValue('${field.id}', ${n})"></i>
                                    `).join('')}
                                </div>
                                <span id="rating-label-${field.id}" class="text-xs text-gray-400 font-medium italic">Pilih rating...</span>
                            </div>
                        `;
                        break;

                    case 'select':
                        fieldHtml = `${labelHtml}
                    <select id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''} 
                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-xl text-sm bg-white cursor-pointer">
                        <option value="" disabled selected>${field.placeholder || 'Pilih salah satu...'}</option>
                        ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>`;
                        break;

                    case 'radio':
                        fieldHtml = `<label class="block text-sm font-medium text-gray-700 mb-2 ${requiredClass}"><span class="label-text">${field.label}</span></label><div class="space-y-2">`;
                        field.options.forEach((option, index) => {
                            fieldHtml += `
                                <label for="${field.id}_${index}" class="option-item flex items-center">
                    <input id="${field.id}_${index}" type="radio" name="${field.id}" value="${option}" 
                    class="text-blue-500 focus:ring-blue-500 cursor-pointer" ${field.required ? 'required' : ''}>
                        <span class="flex items-center">
                            <span class="custom-check"></span>
                            <span class="ml-1 text-sm text-gray-700">${option}</span>
                        </span>
                    </label>`;
                        });
                        fieldHtml += `</div>`;
                        break;

                    case 'checkbox':
                        fieldHtml = `<label class="block text-sm font-medium text-gray-700 mb-2 ${requiredClass}"><span class="label-text">${field.label}</span></label><div class="space-y-2">`;
                        field.options.forEach((option, index) => {
                            fieldHtml += `
                                <label for="${field.id}_${index}" class="option-item flex items-center">
                    <input id="${field.id}_${index}" type="checkbox" name="${field.id}[]" value="${option}" 
                    class="rounded text-blue-500 focus:ring-blue-500 cursor-pointer">
                        <span class="flex items-center">
                            <span class="custom-check"></span>
                            <span class="ml-1 text-sm text-gray-700">${option}</span>
                        </span>
                    </label>`;
                        });
                        fieldHtml += `</div>`;
                        break;

                    default:
                        fieldHtml = `<p class="text-red-500 text-sm font-bold bg-red-50 p-2 rounded">Tipe field tidak dikenal: ${field.type}</p>`;
                }

                const fieldContainer = document.createElement('div');
                fieldContainer.classList.add('field-card', 'bg-white', 'p-5', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-200');
                fieldContainer.innerHTML = fieldHtml;
                formFieldsContainer.appendChild(fieldContainer);
            });

            publicForm.classList.remove('hidden');
        }

        // --- FUNGSI BARU UNTUK RATING ---
        function setRatingValue(fieldId, value) {
            const container = document.getElementById(`rating-container-${fieldId}`);
            const input = document.getElementById(`rating-input-${fieldId}`);
            const label = document.getElementById(`rating-label-${fieldId}`);
            
            input.value = value;
            label.textContent = `Rating: ${value} / 5`;
            label.classList.remove('text-gray-400');
            label.classList.add('text-blue-600', 'font-bold');

            const stars = container.querySelectorAll('.rating-star');
            stars.forEach(star => {
                const starVal = parseInt(star.getAttribute('data-value'));
                if (starVal <= value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // --- LOGIKA VALIDASI CUSTOM CHECKBOX ---
        function validateForm(form) {
            if (!form.checkValidity()) {
                return false; 
            }
            
            if (!formStructure || !formStructure.fields) return true;

            for (const field of formStructure.fields) {
                // Validasi Checkbox Wajib
                if (field.required && field.type === 'checkbox') {
                    const checkboxes = form.querySelectorAll(`input[name="${field.id}[]"]`);
                    const isChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);

                    if (!isChecked) {
                        displayStatus(`Harap pilih minimal satu opsi untuk pertanyaan: "${field.label}".`, true);
                        return false;
                    }
                }
                // Validasi Rating Wajib
                if (field.required && field.type === 'rating') {
                    const ratingInput = form.querySelector(`#rating-input-${field.id}`);
                    if (!ratingInput || !ratingInput.value) {
                        displayStatus(`Harap berikan penilaian untuk pertanyaan: "${field.label}".`, true);
                        return false;
                    }
                }
            }
            return true;
        }

        // --- FUNGSI UTAMA: MENGIRIM DATA (KE API DB & N8N WEBHOOK) ---
        async function handleSubmission(event) {
            event.preventDefault();
            const form = event.target;
            const formId = form.getAttribute('data-form-id');
            const submitBtn = document.getElementById('submitBtn');

            if (!validateForm(form)) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner mr-2"></span>Mengirim Feedback...';

            const formData = new FormData(form);
            const data = {};

            // Kumpulkan data ke dalam objek JSON yang benar
            for (const [key, value] of formData.entries()) {
                if (key.endsWith('[]')) { 
                    const cleanKey = key.slice(0, -2);
                    if (!data[cleanKey]) {
                        data[cleanKey] = [];
                    }
                    data[cleanKey].push(value);
                } else {
                    data[key] = value;
                }
            }

            let dbSuccess = false;
            let dbErrorMessage = 'Gagal menyimpan data.';

            // --- 1. KIRIM KE DATABASE (API.PHP) ---
            try {
                const dbPayload = { response_data: data, form_id: formId }; 

                const response = await fetch(`${API_BASE_URL}?action=submit_feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dbPayload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    dbSuccess = true;
                } else {
                    dbErrorMessage = result.message || 'Error tidak diketahui dari API.';
                    throw new Error(dbErrorMessage);
                }
            } catch (error) {
                console.error('Database Submission Error:', error);
                dbErrorMessage = error.message;
            }
            
            // --- 2. KIRIM KE WEBHOOK N8N (JIKA DB SUKSES) ---
            if (dbSuccess) {
                try {
                    const n8nPayload = { 
                        form_id: formId, 
                        form_title: formStructure.title,
                        submitted_at: new Date().toISOString(),
                        response_data: data 
                    };

                    fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(n8nPayload)
                    }).catch(e => console.warn("Webhook n8n gagal."));
                } catch (error) {}
            }

            // --- 3. FINALISASI UI ---
            if (dbSuccess) {
                displayStatus(`Terima kasih! Feedback Anda berhasil dikirim, dan data anda sudah tersimpan di database.`, false);
                form.reset(); 
            } else {
                displayStatus('Terjadi kesalahan saat menyimpan data. Detail: ' + dbErrorMessage, true);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Kirim Feedback';
            }
        }
    </script>
</body>
</html>