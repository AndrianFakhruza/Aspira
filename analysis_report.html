<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis & Laporan - ASPIRA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .navbar-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .sidebar-link.active {
            background-color: #1e40af;
            color: #fff;
            box-shadow: 0 4px 6px rgba(30, 64, 175, 0.4);
        }

        .sidebar-container {
            width: 256px;
            transition: width 0.3s ease;
        }
        .sidebar-container.collapsed {
            width: 80px;
        }
        .sidebar-container.collapsed .sidebar-text {
            display: none;
        }
        .sidebar-container.collapsed .toggle-button-wrapper .fa-arrow-left {
            transform: rotate(180deg);
        }

        .toggle-button-wrapper {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) translateX(50%);
            transition: transform 0.3s ease;
            z-index: 10;
        }
        
        .btn-gradient {
            background-image: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(30, 64, 175, 0.2);
        }
        .btn-gradient:hover {
            background-image: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(30, 64, 175, 0.6);
        }
        
        /* --- OPTIMASI ANIMASI HOVER --- */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .card-shadow-hover:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            transform: translateY(-5px);
        }
        
        .transition-transform-hover:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-shadow-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- DROPDOWN CUSTOM STYLE --- */
        [type="checkbox"]:checked,
        [type="checkbox"]:not(:checked){
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }
        
        .sec-center-custom {
            position: relative;
            z-index: 200;
        }

        /* WARNA BIRU SESUAI THEME */
        .dropdown:checked + label,
        .dropdown:not(:checked) + label{
            position: relative;
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2; 
            height: 44px; 
            transition: all 200ms linear;
            border-radius: 0.5rem; 
            width: 300px; 
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid #1e40af; 
            background-color: #1e40af; 
            color: #fff; 
            box-shadow: 0 4px 10px 0 rgba(30, 64, 175,.3);
            cursor: pointer;
            padding: 5px 15px; 
        }

        .dropdown:checked + label:hover,
        .dropdown:not(:checked) + label:hover{
            background-color: #3b82f6; 
            border-color: #3b82f6;
        }
        
        .dropdown:not(:checked) + label .uil {
            font-size: 20px;
            margin-left: 10px;
            transition: transform 200ms linear;
        }
        .dropdown:checked + label .uil {
            transform: rotate(180deg);
            font-size: 20px;
            margin-left: 10px;
            transition: transform 200ms linear;
        }
        
        .section-dropdown {
            position: absolute;
            padding: 4px; 
            background-color: #fff; 
            top: 52px; 
            left: 0;
            width: 100%;
            border-radius: 0.5rem; 
            box-shadow: 0 10px 30px 0 rgba(9,9,12,0.15);
            z-index: 2;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: all 200ms linear;
        }
        
        /* SCROLLABLE DROPDOWN */
        #dropdown-options {
            max-height: 200px; 
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        #dropdown-options::-webkit-scrollbar {
            width: 6px;
        }
        #dropdown-options::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
        }
        /* END SCROLLABLE */


        .dropdown:checked ~ .section-dropdown{
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .section-dropdown:after {
            position: absolute;
            top: -7px;
            left: 30px;
            width: 0;  
            height: 0; 
            border-left: 8px solid transparent;
            border-right: 8px solid transparent; 
            border-bottom: 8px solid #fff; 
            content: '';
            display: block;
            z-index: 2;
            transition: all 200ms linear;
        }

        .dropdown-link-item {
            position: relative;
            color: #102770; 
            transition: all 200ms linear;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px; 
            border-radius: 4px;
            padding: 6px 10px; 
            margin: 1px 0; 
            text-align: left;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            white-space: normal; 
            line-height: 1.3;
        }
        
        .dropdown-link-item:hover {
            color: #1e40af; 
            background-color: #e5e7eb; 
        }
        
        .dropdown-link-item .uil {
            font-size: 18px;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        /* CSS Chart Container (Optimized Size) */
        .chart-container {
            position: relative; 
            width: 100%; 
            height: 250px; 
            margin: 0 auto;
        }
        @media (min-width: 1024px) {
            .chart-container {
                max-width: 300px; 
                height: 300px; 
            }
        }
    </style>
</head>
<body>
    
    <div class="flex h-screen bg-gray-50">
        
        <aside id="sidebar" class="sidebar-container navbar-gradient text-white flex flex-col relative h-full">
            <div class="toggle-button-wrapper">
                <button onclick="toggleSidebar(event)" class="w-8 h-8 flex items-center justify-center p-2 rounded-full navbar-gradient text-white shadow-xl hover:shadow-2xl transition-all duration-300">
                    <i id="toggle-icon" class="fas fa-arrow-left text-sm transition-transform duration-300"></i>
                </button>
            </div>

            <div class="flex items-center space-x-3 p-4 border-b border-blue-700/50">
                <div class="flex-shrink-0">
                    <div class="bg-white p-2 rounded-lg border border-gray-200">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1M9 11h1M9 15h1m10-14v2m0 2v2m0 2v2m0 2v2m0 2v2m0 2v2m0-20H5a2 2 0 00-2 2v16a2 2 0 002 2h14a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg>
                    </div>
                </div>
                <div class="flex flex-col sidebar-text flex-grow">
                    <span class="font-extrabold text-sm tracking-wider leading-tight text-white">ASPIRA</span>
                    <span class="font-bold text-xs text-white leading-tight">PERTA ARUN GAS</span>
                </div>
            </div>

            <nav class="flex-grow p-4 space-y-2">
                <a href="index.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-home w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="form_builder.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-magic w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Form Builder</span>
                </a>
                <a href="analysis_report.html" class="sidebar-link active flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-chart-bar w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Analisis & Laporan</span>
                </a>
                <a href="admin_management.html" id="admin-management-link" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-users-cog w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Manajemen Admin</span>
                </a>
            </nav>

            <div class="p-4 border-t border-blue-700/50">
                <button class="w-full flex items-center justify-center p-3 text-sm font-medium rounded-xl text-white hover:bg-red-500 hover:text-white transition-colors duration-200" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-5 h-5 mr-2"></i>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8">
            
            <div class="flex justify-between items-start mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    Analisis Feedback
                </h1>
                
                <div id="form-selection" class="bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 card-shadow-hover">
                    <label for="form-select-custom" class="text-sm font-medium text-gray-700 hidden md:block">Pilih Formulir:</label>
                    
                    <div class="sec-center-custom">
                        <input class="dropdown" type="checkbox" id="dropdown-form-toggle" name="dropdown-form-toggle"/>
                        <label class="for-dropdown" for="dropdown-form-toggle" id="dropdown-label">
                            <span id="selected-form-title">Pilih formulir</span> 
                            <i class="uil uil-arrow-down"></i>
                        </label>
                        <div class="section-dropdown"> 
                            <div id="dropdown-options">
                                <p class="dropdown-link-item text-gray-400">Memuat...</p>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
            
            <div id="initial-instruction" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg shadow-md mb-8 card-shadow-hover">
                <div class="flex items-center">
                    <i class="fas fa-info-circle w-6 h-6 mr-3"></i>
                    <p class="font-bold">Mulai Analisis</p>
                </div>
                <p class="mt-2 text-sm">Silakan **pilih salah satu Formulir** dari kotak *dropdown* di kanan atas untuk memuat laporan analisis.</p>
            </div>
            
            <div id="report-content" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="report-title"></h2>
                
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md border border-gray-100 card-shadow-hover">
                    <p class="text-gray-600">Total Respon Diterima: <span id="total-responses" class="font-semibold text-blue-600">0</span></p>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white font-medium py-2 px-4 rounded-xl text-sm hover:bg-green-700 transition duration-150 transition-smooth transition-transform-hover">
                        <i class="fas fa-file-excel mr-1"></i> Export Excel
                    </button>
                </div>
                
                <div id="field-analysis-results" class="space-y-8 mt-6">
                    </div>

            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/aspira/api.php';
        let formId = null;
        let allResponses = [];
        let globalFormFieldsDefinition = []; // Menyimpan struktur field lengkap dari API

        // Warna untuk Chart.js
        const CHART_COLORS = [
            '#3b82f6', // blue-500
            '#ef4444', // red-500
            '#10b981', // emerald-500
            '#f59e0b', // amber-500
            '#a855f7', // purple-500
            '#ec4899', // pink-500
            '#06b6d4', // cyan-500
            '#f97316', // orange-500
        ];
        
        // Simpan referensi chart untuk penghancuran (destroy) saat mengganti form
        let activeCharts = [];


        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            fetchFormListForDropdown();
            
            const initialFormId = getQueryParam('id');
            if (initialFormId) {
                // Biarkan fetchFormListForDropdown memanggil selectFormFromDropdown
            }
        });
        
        // =========================================================================
        // SIDEBAR AND SESSION LOGIC
        // =========================================================================

        function checkSession() {
            const adminRole = sessionStorage.getItem('adminRole');
            
            if (!adminRole) {
                window.location.href = 'admin_login.html';
                return;
            }
            
            if (adminRole !== 'Super Admin') {
                const adminLink = document.getElementById('admin-management-link');
                if (adminLink) {
                    adminLink.classList.add('hidden');
                }
            }
        }

        function toggleSidebar(event) {
            if (event) event.stopPropagation();
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            const icon = document.getElementById('toggle-icon');
            icon.classList.toggle('fa-arrow-left');
            icon.classList.toggle('fa-arrow-right');
        }
        
        function logout() {
            sessionStorage.removeItem('adminRole');
            sessionStorage.removeItem('adminUsername');
            window.location.href = 'admin_login.html';
        }
        
        // =========================================================================
        // DATA FETCHING AND RENDERING
        // =========================================================================

        async function fetchFormListForDropdown() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=get_forms`);
                const result = await response.json();
                const dropdownOptions = document.getElementById('dropdown-options');
                dropdownOptions.innerHTML = ''; 
                let forms = [];

                if (response.ok && result.success && result.forms.length > 0) {
                    forms = result.forms;
                    forms.forEach(form => {
                        const link = document.createElement('a');
                        link.classList.add('dropdown-link-item');
                        link.href = 'javascript:void(0)';
                        link.setAttribute('data-form-id', form.form_id);
                        link.textContent = form.form_title;
                        link.onclick = (e) => {
                            selectFormFromDropdown(form.form_id, form.form_title);
                            document.getElementById('dropdown-form-toggle').checked = false;
                        };
                        dropdownOptions.appendChild(link);
                    });
                } else {
                    const info = document.createElement('p');
                    info.classList.add('dropdown-link-item', 'text-gray-400');
                    info.textContent = 'Tidak ada formulir aktif';
                    dropdownOptions.appendChild(info);
                }
                
                const initialFormId = getQueryParam('id');
                if (initialFormId && forms.length > 0) {
                    const initialForm = forms.find(f => f.form_id == initialFormId);
                    if (initialForm) {
                        selectFormFromDropdown(initialForm.form_id, initialForm.form_title);
                    }
                }

            } catch (error) {
                console.error('Gagal mengambil daftar formulir:', error);
                document.getElementById('dropdown-options').innerHTML = '<p class="dropdown-link-item text-red-500">Error koneksi server</p>';
            }
        }
        
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function selectFormFromDropdown(id, title) {
            document.getElementById('selected-form-title').textContent = title;
            loadFormData(id);
        }

        async function loadFormData(selectedFormId) {
            if (!selectedFormId) return;
            
            document.getElementById('initial-instruction').classList.add('hidden');
            document.getElementById('report-content').classList.add('hidden');
            document.getElementById('field-analysis-results').innerHTML = `<p class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin mr-2"></i> Memproses analisis data...</p>`;
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            formId = selectedFormId;

            try {
                const response = await fetch(`${API_BASE_URL}?action=get_form_and_responses&id=${formId}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    document.getElementById('report-title').textContent = `Laporan Analisis: ${result.form_title}`;
                    document.getElementById('total-responses').textContent = result.total_responses;
                    
                    allResponses = result.responses;
                    globalFormFieldsDefinition = result.form_fields;
                    
                    document.getElementById('report-content').classList.remove('hidden');
                    
                    // --- FUNGSI ANALISIS BARU ---
                    const aggregatedDataMap = aggregateResponses(allResponses, globalFormFieldsDefinition);
                    renderAnalysisSections(aggregatedDataMap, result.total_responses, globalFormFieldsDefinition);
                    // ----------------------------

                } else {
                    alert('Gagal memuat laporan: ' + (result.message || 'Error tidak diketahui.'));
                    document.getElementById('report-content').classList.add('hidden');
                    document.getElementById('initial-instruction').classList.remove('hidden'); 
                }
            } catch (error) {
                console.error('Load data error:', error);
                alert('Terjadi kesalahan saat memuat data laporan (Koneksi Server).');
                document.getElementById('initial-instruction').classList.remove('hidden');
            }
        }
        
        // =========================================================================
        // FUNGSI AGREGASI & RENDERING ANALISIS
        // =========================================================================
        
        // Fungsi aggregateResponses kini mengembalikan Map (Objek) agar mudah diakses
        function aggregateResponses(responses, fieldsDefinition) {
            const aggregatedDataMap = {};
            
            // 1. Buat Map Label Bersih -> Field Definition
            const fieldMap = {};
            fieldsDefinition.forEach(field => {
                const cleanLabel = (field.label || field.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                fieldMap[cleanLabel] = {
                    label: field.label,
                    type: field.type,
                    options: field.options || []
                };
            });

            responses.forEach(response => {
                for (const key in response) {
                    if (key === 'submitted_at') continue; 
                    
                    const fieldDef = fieldMap[key];
                    if (!fieldDef) continue;
                    
                    const fieldType = fieldDef.type;
                    const answer = response[key];
                    
                    if (!aggregatedDataMap[key]) {
                        aggregatedDataMap[key] = {
                            label: fieldDef.label,
                            type: fieldType,
                            totalCount: 0,
                            data: (fieldType === 'radio' || fieldType === 'select' || fieldType === 'checkbox') ? {} : []
                        };
                    }
                    
                    // Hanya menghitung baris yang ada jawabannya, BUKAN total responden
                    // Jumlah responden total diambil dari responses.length
                    
                    if (['text', 'number', 'textarea'].includes(fieldType)) {
                        if (answer !== null && answer !== undefined && answer !== '') {
                            aggregatedDataMap[key].data.push(answer);
                            aggregatedDataMap[key].totalCount++;
                        }
                    } else if (fieldType === 'radio' || fieldType === 'select') {
                        const option = String(answer).trim();
                        if (option !== '' && option !== 'undefined' && option !== 'null') {
                            aggregatedDataMap[key].data[option] = (aggregatedDataMap[key].data[option] || 0) + 1;
                            aggregatedDataMap[key].totalCount++;
                        }
                    } else if (fieldType === 'checkbox' && Array.isArray(answer)) {
                        let isAnswered = false;
                        answer.forEach(option => {
                            const optKey = String(option).trim();
                            if (optKey !== '') {
                                aggregatedDataMap[key].data[optKey] = (aggregatedDataMap[key].data[optKey] || 0) + 1;
                                isAnswered = true;
                            }
                        });
                        // Hanya tambahkan 1 ke totalCount jika responden memilih minimal satu opsi
                        if(isAnswered) {
                            aggregatedDataMap[key].totalCount++;
                        }
                    }
                }
            });

            return aggregatedDataMap;
        }

        // FUNGSI YANG DIKOREKSI: Memastikan iterasi dilakukan berdasarkan urutan field asli (globalFormFieldsDefinition)
        function renderAnalysisSections(aggregatedDataMap, totalResponses, fieldsDefinition) {
            const container = document.getElementById('field-analysis-results');
            container.innerHTML = ''; 

            if (totalResponses === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 p-8">Belum ada respon yang masuk untuk form ini.</p>`;
                 return;
            }

            // ITERASI BERDASARKAN URUTAN FIELDS DEFINITION DARI DATABASE
            fieldsDefinition.forEach((fieldDefinition, index) => {
                const cleanLabel = (fieldDefinition.label || fieldDefinition.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const fieldData = aggregatedDataMap[cleanLabel];
                
                // Jika field tidak memiliki data (belum diisi oleh responden), lewati saja atau berikan placeholder. 
                // Kita akan menggunakan data aggregation yang sudah ada (meskipun totalCount mungkin 0)
                if (!fieldData) return; 

                const section = document.createElement('div');
                section.classList.add('bg-white', 'p-6', 'rounded-2xl', 'shadow-xl', 'border', 'border-gray-100', 'card-shadow-hover', 'transition-smooth', 'transition-transform-hover');
                
                let htmlContent = `<h3 class="text-xl font-bold mb-4 text-gray-800">${fieldData.label}</h3>`;
                
                if (['text', 'number', 'textarea'].includes(fieldData.type)) {
                    htmlContent += renderTextualData(fieldData, totalResponses);
                
                } else if (['radio', 'select'].includes(fieldData.type)) {
                    htmlContent += renderPieChartData(fieldData, totalResponses, index);

                } else if (fieldData.type === 'checkbox') {
                    htmlContent += renderCheckboxData(fieldData, index);
                }

                section.innerHTML = htmlContent;
                container.appendChild(section);
            });
            
            // Render chart harus dilakukan setelah semua canvas di-inject ke DOM
            fieldsDefinition.forEach((fieldDefinition, index) => {
                const cleanLabel = (fieldDefinition.label || fieldDefinition.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const fieldData = aggregatedDataMap[cleanLabel];

                if (fieldData && ['radio', 'select'].includes(fieldData.type)) {
                    drawPieChart(`chart-canvas-${index}`, fieldData, totalResponses);
                }
            });
        }
        
        // --- RENDERING FUNGSI INDIVIDUAL ---

        // 1. TEXTUAL DATA (text, number, textarea)
        function renderTextualData(fieldData, totalResponses) {
            let html = `<p class="text-sm text-gray-600 mb-4">Total Jawaban Terisi: <span class="font-semibold text-blue-600">${fieldData.data.length}</span> / ${totalResponses}</p>`;
            
            if (fieldData.data.length === 0) {
                html += `<p class="text-gray-500 italic mt-2">Belum ada jawaban terisi untuk field ini.</p>`;
                return html;
            }

            const displayData = fieldData.data.slice(0, 10);
            
            html += `<ul class="space-y-2 max-h-60 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200">`;
            displayData.forEach(answer => {
                html += `<li class="p-2 border-b border-gray-100 last:border-b-0 text-gray-700 text-sm">${answer}</li>`;
            });
            html += `</ul>`;
            
            if (fieldData.data.length > 10) {
                 html += `<p class="text-xs text-gray-500 mt-2 italic">Menampilkan 10 jawaban teratas. Download Excel untuk melihat semua ${fieldData.data.length} jawaban.</p>`;
            }
            
            return html;
        }
        
        // 2. PIE CHART DATA (radio, select)
        function renderPieChartData(fieldData, totalResponses, index) {
            const canvasId = `chart-canvas-${index}`;
            
            let html = `<div class="flex flex-col lg:flex-row items-center lg:items-start space-y-6 lg:space-y-0 lg:space-x-8">`;
            
            // Canvas untuk Chart.js
            html += `<div class="chart-container flex-shrink-0"><canvas id="${canvasId}"></canvas></div>`;

            // Legenda dan Persentase
            html += `<div class="flex-grow w-full lg:w-auto p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-3">Rincian Pilihan:</h4>
                        <ul id="legend-${canvasId}" class="space-y-2">`;
            
            const sortedOptions = Object.entries(fieldData.data).sort((a, b) => b[1] - a[1]);
            
            // Total jawaban yang masuk (bukan total responden)
            const totalAnsweredCount = Object.values(fieldData.data).reduce((sum, count) => sum + count, 0);

            if (totalAnsweredCount === 0) {
                html += `<p class="text-gray-500 italic mt-2">Belum ada jawaban terisi untuk pilihan ini.</p>`;
            } else {
                sortedOptions.forEach((entry, colorIndex) => {
                    const option = entry[0];
                    const count = entry[1];
                    // Persentase dihitung dari total pilihan yang masuk (totalAnsweredCount), bukan totalResponses
                    const percentage = ((count / totalAnsweredCount) * 100).toFixed(1); 
                    const color = CHART_COLORS[colorIndex % CHART_COLORS.length];
                    
                    html += `<li class="flex justify-between items-center text-sm">
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${color};"></span>
                                    <span class="text-gray-700">${option}</span>
                                </div>
                                <span class="font-bold text-gray-900">${percentage}% <span class="text-gray-500 font-normal">(${count})</span></span>
                            </li>`;
                });
            }

            html += `</ul></div></div>`;
            return html;
        }

        function drawPieChart(canvasId, fieldData, totalResponses) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const labels = Object.keys(fieldData.data);
            const dataCounts = Object.values(fieldData.data);
            
            const dataColors = dataCounts.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const newChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataCounts,
                        backgroundColor: dataColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false 
                        },
                        title: {
                            display: true,
                            text: `Distribusi Jawaban (${fieldData.totalCount} Responden mengisi)`,
                            font: { size: 14 }
                        }
                    }
                }
            });
            activeCharts.push(newChart);
        }
        
        // 3. CHECKBOX DATA (Tabel Frekuensi)
        function renderCheckboxData(fieldData, index) {
            // TotalCount di sini adalah jumlah responden yang mengisi (memilih minimal 1 opsi)
            let html = `<p class="text-sm text-gray-600 mb-4">Total Responden Mengisi: <span class="font-semibold text-blue-600">${fieldData.totalCount}</span></p>`;
            
            if (Object.keys(fieldData.data).length === 0) {
                html += `<p class="text-gray-500 italic mt-2">Belum ada pilihan yang dipilih.</p>`;
                return html;
            }

            html += `<div class="overflow-x-auto p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/4">Pilihan</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Jumlah Pemilih</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;

            const sortedOptions = Object.entries(fieldData.data).sort((a, b) => b[1] - a[1]);

            sortedOptions.forEach(entry => {
                const option = entry[0];
                const count = entry[1];
                html += `<tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 w-3/4">${option}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-gray-900 text-right w-1/4">${count}</td>
                        </tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        // =========================================================================
        // EKSPOR EXCEL
        // =========================================================================
        
        function exportToExcel() {
            if (!formId || allResponses.length === 0) {
                alert('Tidak ada data respon untuk diekspor. Pilih formulir terlebih dahulu.');
                return;
            }
            window.open(`${API_BASE_URL}?action=export_excel&id=${formId}`, '_blank');
        }
    </script>
</body>
</html>