<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Formulir - ASPIRA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .navbar-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .sidebar-link.active {
            background-color: #1e40af;
            color: #fff;
            box-shadow: 0 4px 6px rgba(30, 64, 175, 0.4);
        }

        .sidebar-container {
            width: 256px;
            transition: width 0.3s ease;
        }
        .sidebar-container.collapsed {
            width: 80px;
        }
        .sidebar-container.collapsed .sidebar-text {
            display: none;
        }
        .sidebar-container.collapsed .toggle-button-wrapper .fa-arrow-left {
            transform: rotate(180deg);
        }

        .toggle-button-wrapper {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) translateX(50%);
            transition: transform 0.3s ease;
            z-index: 10;
        }
        
        .btn-gradient {
            background-image: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(30, 64, 175, 0.2);
        }
        .btn-gradient:hover {
            background-image: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(30, 64, 175, 0.6);
        }
        
        /* --- OPTIMASI ANIMASI HOVER --- */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .card-shadow-hover:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            transform: translateY(-5px);
        }
        
        .transition-transform-hover:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-shadow-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- DROPDOWN CUSTOM STYLE --- */
        [type="checkbox"]:checked,
        [type="checkbox"]:not(:checked){
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }
        
        .sec-center-custom {
            position: relative;
            z-index: 200;
        }

        /* WARNA BIRU SESUAI THEME */
        .dropdown:checked + label,
        .dropdown:not(:checked) + label{
            position: relative;
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2; 
            height: 44px; 
            transition: all 200ms linear;
            border-radius: 0.5rem; 
            width: 300px; 
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid #1e40af; 
            background-color: #1e40af; 
            color: #fff; 
            box-shadow: 0 4px 10px 0 rgba(30, 64, 175,.3);
            cursor: pointer;
            padding: 5px 15px; 
        }

        .dropdown:checked + label:hover,
        .dropdown:not(:checked) + label:hover{
            background-color: #3b82f6; 
            border-color: #3b82f6;
        }
        
        .dropdown:not(:checked) + label .uil {
            font-size: 20px;
            margin-left: 10px;
            transition: transform 200ms linear;
        }
        .dropdown:checked + label .uil {
            transform: rotate(180deg);
            font-size: 20px;
            margin-left: 10px;
            transition: transform 200ms linear;
        }
        
        .section-dropdown {
            position: absolute;
            padding: 4px; 
            background-color: #fff; 
            top: 52px; 
            left: 0;
            width: 100%;
            border-radius: 0.5rem; 
            box-shadow: 0 10px 30px 0 rgba(9,9,12,0.15);
            z-index: 2;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: all 200ms linear;
        }
        
        /* SCROLLABLE DROPDOWN */
        #dropdown-options {
            max-height: 200px; 
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        #dropdown-options::-webkit-scrollbar {
            width: 6px;
        }
        #dropdown-options::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
        }
        /* END SCROLLABLE */


        .dropdown:checked ~ .section-dropdown{
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .section-dropdown:after {
            position: absolute;
            top: -7px;
            left: 30px;
            width: 0;  
            height: 0; 
            border-left: 8px solid transparent;
            border-right: 8px solid transparent; 
            border-bottom: 8px solid #fff; 
            content: '';
            display: block;
            z-index: 2;
            transition: all 200ms linear;
        }

        .dropdown-link-item {
            position: relative;
            color: #102770; 
            transition: all 200ms linear;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px; 
            border-radius: 4px;
            padding: 6px 10px; 
            margin: 1px 0; 
            text-align: left;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            white-space: normal; 
            line-height: 1.3;
        }
        
        .dropdown-link-item:hover {
            color: #1e40af; 
            background-color: #e5e7eb; 
        }
        
        .dropdown-link-item .uil {
            font-size: 18px;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        /* CSS Chart Container (Optimized Size) */
        .chart-container {
            position: relative; 
            width: 100%; 
            height: 250px; 
            margin: 0 auto;
        }
        @media (min-width: 1024px) {
            .chart-container {
                max-width: 300px; 
                height: 300px; 
            }
        }

        /* Style untuk Analisis Global */
        .analysis-point {
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 3px solid #3b82f6;
        }

        /* NEW: Styles for 2-column layout */
        .chart-grid-wrapper {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem; 
        }
        .chart-card-col {
            padding: 0.75rem;
            width: 100%; 
        }
        @media (min-width: 1024px) {
             /* Set to half width on desktop, leaving space for margin/gap */
            .chart-card-col {
                width: 50%;
            }
            /* Style for full width card when needed (e.g., last odd card) */
            .chart-card-col.full-width-lg {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    
    <div class="flex h-screen bg-gray-50">
        
        <aside id="sidebar" class="sidebar-container navbar-gradient text-white flex flex-col relative h-full">
            <div class="toggle-button-wrapper">
                <button onclick="toggleSidebar(event)" class="w-8 h-8 flex items-center justify-center p-2 rounded-full navbar-gradient text-white shadow-xl hover:shadow-2xl transition-all duration-300">
                    <i id="toggle-icon" class="fas fa-arrow-left text-sm transition-transform duration-300"></i>
                </button>
            </div>

            <div class="flex items-center space-x-3 p-4 border-b border-blue-700/50">
                <div class="flex-shrink-0">
                    <div class="bg-white p-2 rounded-lg border border-gray-200">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1M9 11h1M9 15h1m10-14v2m0 2v2m0 2v2m0 2v2m0 2v2m0 2v2m0-20H5a2 2 0 00-2 2v16a2 2 0 002 2h14a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg>
                    </div>
                </div>
                <div class="flex flex-col sidebar-text flex-grow">
                    <span class="font-extrabold text-sm tracking-wider leading-tight text-white">ASPIRA</span>
                    <span class="font-bold text-xs text-white leading-tight">PERTA ARUN GAS</span>
                </div>
            </div>

            <nav class="flex-grow p-4 space-y-2">
                <a href="dashboard.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-home w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="form_builder.html" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-magic w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Form Builder</span>
                </a>
                <a href="analysis_report.html" class="sidebar-link active flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-chart-bar w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Analisis Formulir</span>
                </a>
                <a href="admin_management.html" id="admin-management-link" class="sidebar-link flex items-center p-3 rounded-xl transition-colors duration-200 hover:bg-blue-700">
                    <i class="fas fa-users-cog w-5 h-5 mr-3"></i>
                    <span class="sidebar-text">Manajemen Admin</span>
                </a>
            </nav>

            <div class="p-4 border-t border-blue-700/50">
                <button class="w-full flex items-center justify-center p-3 text-sm font-medium rounded-xl text-white hover:bg-red-500 hover:text-white transition-colors duration-200" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-5 h-5 mr-2"></i>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8">
            
            <div class="flex justify-between items-start mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    Analisis Formulir
                </h1>
                
                <div id="form-selection" class="bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 card-shadow-hover">
                    <label for="form-select-custom" class="text-sm font-medium text-gray-700 hidden md:block">Pilih Formulir:</label>
                    
                    <div class="sec-center-custom">
                        <input class="dropdown" type="checkbox" id="dropdown-form-toggle" name="dropdown-form-toggle"/>
                        <label class="for-dropdown" for="dropdown-form-toggle" id="dropdown-label">
                            <span id="selected-form-title">Pilih formulir</span> 
                            <i class="uil uil-arrow-down"></i>
                        </label>
                        <div class="section-dropdown"> 
                            <div id="dropdown-options">
                                <p class="dropdown-link-item text-gray-400">Memuat...</p>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
            
            <div id="initial-instruction" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg shadow-md mb-8 card-shadow-hover">
                <div class="flex items-center">
                    <i class="fas fa-info-circle w-6 h-6 mr-3"></i>
                    <p class="font-bold">Mulai Analisis</p>
                </div>
                <p class="mt-2 text-sm">Silakan **pilih salah satu Formulir** dari kotak *dropdown* di kanan atas untuk memuat laporan analisis.</p>
            </div>
            
            <div id="report-content" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="report-title"></h2>
                
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md border border-gray-100 card-shadow-hover">
                    <div class="flex items-center space-x-4">
                        <p class="text-gray-600">Total Respon Diterima: <span id="total-responses" class="font-semibold text-blue-600">0</span></p>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="scrollToGlobalAnalysis()" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-xl text-sm hover:bg-blue-700 transition duration-150 transition-smooth transition-transform-hover">
                            <i class="fas fa-chart-line mr-1"></i> Lihat Analisis Global
                        </button>
                    </div>
                </div>
                
                <div id="field-analysis-results" class="chart-grid-wrapper">
                </div>
                <div id="global-analysis-section" class="mt-10 pt-6">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4">ðŸ”¬ Ringkasan Analisis Global</h2>
                    <div id="global-analysis-content" class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 card-shadow-hover">
                         <p class="text-gray-500 italic">Analisis global akan dimuat setelah memilih formulir...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Mendaftarkan plugin datalabels secara global
        Chart.register(ChartDataLabels);

        const API_BASE_URL = 'http://localhost:8080/aspira/api.php';
        let formId = null;
        let allResponses = [];
        let globalFormFieldsDefinition = []; 
        let globalFormTitle = '';

        // Warna untuk Chart.js
        const CHART_COLORS = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b',
            '#a855f7', '#ec4899', '#06b6d4', '#f97316',
        ];
        
        let activeCharts = [];


        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            fetchFormListForDropdown();
            
            const initialFormId = getQueryParam('id');
            if (initialFormId) {
                // Logic to handle initial form load is handled inside fetchFormListForDropdown
            }
        });
        
        // =========================================================================
        // SIDEBAR AND SESSION LOGIC
        // =========================================================================

        function checkSession() {
            const adminRole = sessionStorage.getItem('adminRole');
            if (!adminRole) {
                window.location.href = 'index.html';
                return;
            }
            if (adminRole !== 'Super Admin') {
                const adminLink = document.getElementById('admin-management-link');
                if (adminLink) {
                    adminLink.classList.add('hidden');
                }
            }
        }

        function toggleSidebar(event) {
            if (event) event.stopPropagation();
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            const icon = document.getElementById('toggle-icon');
            icon.classList.toggle('fa-arrow-left');
            icon.classList.toggle('fa-arrow-right');
        }
        
        function logout() {
            sessionStorage.removeItem('adminRole');
            sessionStorage.removeItem('adminUsername');
            window.location.href = 'index.html';
        }
        
        // NEW FUNCTION: Scroll ke Analisis Global
        function scrollToGlobalAnalysis() {
            const targetElement = document.getElementById('global-analysis-section');
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // =========================================================================
        // DATA FETCHING AND RENDERING
        // =========================================================================

        async function fetchFormListForDropdown() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=get_forms`);
                const result = await response.json();
                const dropdownOptions = document.getElementById('dropdown-options');
                dropdownOptions.innerHTML = ''; 
                let forms = [];

                if (response.ok && result.success && result.forms.length > 0) {
                    forms = result.forms;
                    forms.forEach(form => {
                        const link = document.createElement('a');
                        link.classList.add('dropdown-link-item');
                        link.href = 'javascript:void(0)';
                        link.setAttribute('data-form-id', form.form_id);
                        
                        // FIX: Tampilkan NAMA FORM LENGKAP di dalam daftar dropdown
                        link.textContent = form.form_title;
                        link.title = form.form_title;
                        
                        link.onclick = (e) => {
                            selectFormFromDropdown(form.form_id, form.form_title);
                            document.getElementById('dropdown-form-toggle').checked = false;
                        };
                        dropdownOptions.appendChild(link);
                    });
                } else {
                    const info = document.createElement('p');
                    info.classList.add('dropdown-link-item', 'text-gray-400');
                    info.textContent = 'Tidak ada formulir aktif';
                    dropdownOptions.appendChild(info);
                }
                
                const initialFormId = getQueryParam('id');
                if (initialFormId && forms.length > 0) {
                    const initialForm = forms.find(f => f.form_id == initialFormId);
                    if (initialForm) {
                        selectFormFromDropdown(initialForm.form_id, initialForm.form_title);
                    }
                }

            } catch (error) {
                console.error('Gagal mengambil daftar formulir:', error);
                document.getElementById('dropdown-options').innerHTML = '<p class="dropdown-link-item text-red-500">Error koneksi server</p>';
            }
        }
        
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function selectFormFromDropdown(id, title) {
            // NEW LOGIC: Potong nama form menjadi maksimal 3 kata untuk tampilan label terpilih
            const words = title.split(/\s+/);
            const displayTitle = words.length > 3 
                ? words.slice(0, 3).join(' ') + '...'
                : title;
                
            document.getElementById('selected-form-title').textContent = displayTitle;
            
            globalFormTitle = title; // Simpan nama lengkap untuk analisis
            loadFormData(id);
        }

        async function loadFormData(selectedFormId) {
            if (!selectedFormId) return;
            
            document.getElementById('initial-instruction').classList.add('hidden');
            document.getElementById('report-content').classList.add('hidden');
            document.getElementById('field-analysis-results').innerHTML = `<p class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin mr-2"></i> Memproses analisis data...</p>`;
            document.getElementById('global-analysis-content').innerHTML = `<p class="text-gray-500 italic"><i class="fas fa-spinner fa-spin mr-2"></i> Menghasilkan analisis global...</p>`;
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            formId = selectedFormId;

            try {
                const response = await fetch(`${API_BASE_URL}?action=get_form_and_responses&id=${formId}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    // JUDUL DIUBAH: Analisis <nama formulir>
                    document.getElementById('report-title').textContent = `Analisis ${result.form_title}`;
                    document.getElementById('total-responses').textContent = result.total_responses;
                    
                    allResponses = result.responses;
                    globalFormFieldsDefinition = result.form_fields;
                    globalFormTitle = result.form_title;
                    
                    document.getElementById('report-content').classList.remove('hidden');
                    
                    const aggregatedDataMap = aggregateResponses(allResponses, globalFormFieldsDefinition);
                    renderAnalysisSections(aggregatedDataMap, result.total_responses, globalFormFieldsDefinition);
                    
                    // Panggil fungsi Analisis Global
                    generateGlobalAnalysis(aggregatedDataMap, result.total_responses, globalFormTitle, globalFormFieldsDefinition);

                } else {
                    alert('Gagal memuat laporan: ' + (result.message || 'Error tidak diketahui.'));
                    document.getElementById('report-content').classList.add('hidden');
                    document.getElementById('initial-instruction').classList.remove('hidden'); 
                }
            } catch (error) {
                console.error('Load data error:', error);
                alert('Terjadi kesalahan saat memuat data laporan (Koneksi Server).');
                document.getElementById('initial-instruction').classList.remove('hidden');
            }
        }
        
        // =========================================================================
        // FUNGSI UTAMA ANALISIS GLOBAL (FINAL DENGAN LOGIKA TIE-BREAKER)
        // =========================================================================

        function generateGlobalAnalysis(aggregatedDataMap, totalResponses, formTitle, fieldsDefinition) {
            const container = document.getElementById('global-analysis-content');
            let analysisHtml = '';
            
            if (totalResponses === 0) {
                container.innerHTML = `<p class="text-red-500 font-semibold">Tidak ada data responden untuk dianalisis.</p>`;
                return;
            }

            // 1. HEADER NARASI: 
            analysisHtml += `<p class="text-lg text-gray-700 mb-4 leading-relaxed">
                <i class="fas fa-file-alt text-blue-500 mr-2"></i> 
                Laporan ini menyajikan ringkasan analisis untuk formulir "${formTitle}". 
                Survei ini telah diisi oleh total ${totalResponses} responden. 
                Berikut adalah analisis mendalam berdasarkan data yang terkumpul:
            </p>
            <hr class="my-4">
            <div class="space-y-6 text-gray-800">`;

            let analysisBody = '';
            
            // 2. ITERASI PER FIELD (Analisis Kuantitatif)
            fieldsDefinition.forEach(fieldDefinition => {
                const cleanLabel = (fieldDefinition.label || fieldDefinition.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const fieldData = aggregatedDataMap[cleanLabel];
                
                if (!fieldData || fieldData.totalCount === 0) return;
                
                const fieldType = fieldData.type;

                // Analisis untuk Pilihan Tunggal (Radio/Select)
                if (['radio', 'select'].includes(fieldType)) {
                    const data = fieldData.data;
                    const totalAnswered = fieldData.totalCount;

                    if (totalAnswered > 0) {
                        const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
                        const maxFreq = entries[0][1];
                        
                        // Menangani data seri (Tie-breaker)
                        const winners = entries.filter(e => e[1] === maxFreq);
                        const names = winners.map(e => `'${e[0]}'`).join(' dan ');
                        const percentage = ((maxFreq / totalAnswered) * 100).toFixed(1);
                        const suffix = winners.length > 1 ? `masing-masing ${maxFreq}` : `${maxFreq}`;
                        
                        analysisBody += `
                            <div class="analysis-point">
                                <p class="font-bold text-base text-blue-800 mb-1">
                                    ${fieldData.label} 
                                    <span class="text-sm font-normal text-gray-600">(${totalAnswered} Responden Mengisi)</span>
                                </p>
                                <p class="ml-4 text-sm text-gray-700">
                                    Frekuensi tertinggi terletak pada opsi ${names} dengan persentase ${percentage}% (yaitu ${suffix} responden).
                                </p>
                            </div>`; 
                    }
                } 
                // Analisis untuk Rating (UPDATE: Tanpa 'kepuasan' dan Tren)
                else if (fieldType === 'rating') {
                    const data = fieldData.data;
                    let sum = 0;
                    let count = 0;
                    for(let i=1; i<=5; i++) {
                        if(data[i]) {
                            sum += (i * data[i]);
                            count += data[i];
                        }
                    }
                    const avg = count > 0 ? (sum / count).toFixed(1) : 0;
                    analysisBody += `
                        <div class="analysis-point">
                            <p class="font-bold text-base text-blue-800 mb-1">
                                ${fieldData.label}
                                <span class="text-sm font-normal text-gray-600">(${count} Penilaian)</span>
                            </p>
                            <p class="ml-4 text-sm text-gray-700">
                                Skor rata-rata adalah <strong>${avg} / 5.0</strong>.
                            </p>
                        </div>`;
                }
                
                // Analisis untuk Checkbox (Pilihan Ganda)
                else if (fieldType === 'checkbox') {
                     const data = fieldData.data;
                     const totalAnswered = fieldData.totalCount;

                     if (totalAnswered > 0) {
                        const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
                        const maxFreq = entries[0][1];
                        
                        const winners = entries.filter(e => e[1] === maxFreq);
                        const names = winners.map(e => `'${e[0]}'`).join(' dan ');
                        const suffix = winners.length > 1 ? `masing-masing ${maxFreq}` : `${maxFreq}`;

                        analysisBody += `
                            <div class="analysis-point">
                                <p class="font-bold text-base text-blue-800 mb-1">
                                    ${fieldData.label} 
                                    <span class="text-sm font-normal text-gray-600">(${totalAnswered} Responden Mengisi)</span>
                                </p>
                                <p class="ml-4 text-sm text-gray-700">
                                    Ini adalah Pertanyaan Pilihan Ganda. Opsi yang paling sering dipilih adalah ${names}, dipilih oleh ${suffix} responden.
                                </p>
                            </div>`;
                     }
                }
            });

            // 3. PENUTUP
            analysisHtml += analysisBody;
            analysisHtml += `</div>`;
            
            container.innerHTML = analysisHtml;
        }

        // =========================================================================
        // FUNGSI AGREGASI & RENDERING VISUAL
        // =========================================================================

        function aggregateResponses(responses, fieldsDefinition) {
            const aggregatedDataMap = {};
            
            const fieldMap = {};
            fieldsDefinition.forEach(field => {
                const cleanLabel = (field.label || field.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                fieldMap[cleanLabel] = {
                    label: field.label,
                    type: field.type,
                    options: field.options || [],
                    id: field.id
                };
            });

            responses.forEach(response => {
                const rData = response.response_data || response;

                for (const key in fieldMap) {
                    const fieldDef = fieldMap[key];
                    const fieldId = fieldDef.id;
                    const fieldType = fieldDef.type;
                    const answer = rData[fieldId] || rData[key];
                    
                    if (answer === undefined || answer === null) continue;

                    if (!aggregatedDataMap[key]) {
                        aggregatedDataMap[key] = {
                            label: fieldDef.label,
                            type: fieldType,
                            totalCount: 0,
                            data: (['radio', 'select', 'checkbox', 'rating'].includes(fieldType)) ? {} : []
                        };
                    }
                    
                    if (['text', 'number', 'textarea'].includes(fieldType)) {
                        if (answer !== '') {
                            aggregatedDataMap[key].data.push(answer);
                            aggregatedDataMap[key].totalCount++;
                        }
                    } else if (fieldType === 'radio' || fieldType === 'select' || fieldType === 'rating') {
                        const option = String(answer).trim();
                        if (option !== '') {
                            aggregatedDataMap[key].data[option] = (aggregatedDataMap[key].data[option] || 0) + 1;
                            aggregatedDataMap[key].totalCount++;
                        }
                    } else if (fieldType === 'checkbox' && Array.isArray(answer)) {
                        let isAnswered = false;
                        answer.forEach(option => {
                            const optKey = String(option).trim();
                            if (optKey !== '') {
                                aggregatedDataMap[key].data[optKey] = (aggregatedDataMap[key].data[optKey] || 0) + 1;
                                isAnswered = true;
                            }
                        });
                        if(isAnswered) {
                            aggregatedDataMap[key].totalCount++;
                        }
                    }
                }
            });

            return aggregatedDataMap;
        }

        function renderAnalysisSections(aggregatedDataMap, totalResponses, fieldsDefinition) {
            const container = document.getElementById('field-analysis-results');
            container.innerHTML = ''; 

            if (totalResponses === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 p-8">Belum ada respon yang masuk untuk form ini.</p>`;
                 return;
            }

            let chartFieldIndex = 0;
            
            fieldsDefinition.forEach((fieldDefinition, originalIndex) => {
                const cleanLabel = (fieldDefinition.label || fieldDefinition.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const fieldData = aggregatedDataMap[cleanLabel];
                
                if (!fieldData) return;

                const fieldType = fieldData.type;
                const isChartOrChoice = ['radio', 'select'].includes(fieldType);
                const isTableBased = ['checkbox', 'rating'].includes(fieldType);
                const isTextual = ['text', 'number', 'textarea'].includes(fieldType);

                let sectionWrapper = document.createElement('div');
                let section = document.createElement('div');
                section.className = 'bg-white p-6 rounded-2xl shadow-xl border border-gray-100 card-shadow-hover transition-smooth transition-transform-hover h-full';
                
                let htmlContent = `<h3 class="text-xl font-bold mb-4 text-gray-800">${fieldData.label}</h3>`;
                
                if (isChartOrChoice) {
                    sectionWrapper.className = 'chart-card-col';
                    htmlContent += renderPieChartData(fieldData, totalResponses, chartFieldIndex);
                    fieldData.chartRenderIndex = chartFieldIndex;
                    chartFieldIndex++; 
                } 
                else if (isTableBased) {
                    sectionWrapper.className = 'chart-card-col';
                    if (fieldType === 'checkbox') {
                        htmlContent += renderCheckboxData(fieldData);
                    } else {
                        htmlContent += renderRatingData(fieldData);
                    }
                }
                else if (isTextual) {
                    sectionWrapper.className = 'chart-card-col full-width-lg';
                    htmlContent += renderTextualData(fieldData, totalResponses);
                }

                section.innerHTML = htmlContent;
                sectionWrapper.appendChild(section);
                container.appendChild(sectionWrapper);
            });

            fieldsDefinition.forEach(fieldDefinition => {
                const cleanLabel = (fieldDefinition.label || fieldDefinition.id).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const fieldData = aggregatedDataMap[cleanLabel];
                if (fieldData && ['radio', 'select'].includes(fieldData.type) && typeof fieldData.chartRenderIndex === 'number') {
                    drawPieChart(`chart-canvas-${fieldData.chartRenderIndex}`, fieldData, totalResponses);
                }
            });
        }
        
        // --- RENDERING FUNGSI INDIVIDUAL ---

        function renderRatingData(fieldData) {
            const data = fieldData.data;
            let sum = 0;
            let count = 0;
            for(let i=1; i<=5; i++) {
                if(data[i]) {
                    sum += (i * data[i]);
                    count += data[i];
                }
            }
            const avg = count > 0 ? (sum / count).toFixed(1) : 0;

            let html = `
                <div class="flex items-center space-x-4 mb-4">
                    <div class="bg-blue-600 text-white p-3 rounded-xl text-center min-w-[80px]">
                        <p class="text-2xl font-extrabold">${avg}</p>
                        <p class="text-[10px] uppercase font-bold">Rata-rata</p>
                    </div>
                    <div class="flex-grow">
                        <div class="flex text-yellow-400 text-lg mb-1">
                            ${[1,2,3,4,5].map(i => `<i class="${i <= Math.round(avg) ? 'fas' : 'far'} fa-star"></i>`).join('')}
                        </div>
                        <p class="text-xs text-gray-500">Berdasarkan ${count} penilaian responden.</p>
                    </div>
                </div>
                <div class="space-y-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
            `;

            for (let i = 5; i >= 1; i--) {
                const freq = data[i] || 0;
                const perc = count > 0 ? (freq / count * 100).toFixed(0) : 0;
                html += `
                    <div class="flex items-center text-xs">
                        <span class="w-12 font-medium">${i} Bintang</span>
                        <div class="flex-grow h-2 bg-gray-200 rounded-full mx-3 overflow-hidden">
                            <div class="h-full bg-blue-500" style="width: ${perc}%"></div>
                        </div>
                        <span class="w-8 text-right font-bold">${freq}</span>
                    </div>
                `;
            }
            html += `</div>`;
            return html;
        }

        function renderTextualData(fieldData, totalResponses) {
            let html = `<p class="text-sm text-gray-600 mb-4">Total Jawaban Terisi: <span class="font-semibold text-blue-600">${fieldData.data.length}</span> / ${totalResponses}</p>`;
            
            if (fieldData.data.length === 0) {
                html += `<p class="text-gray-500 italic mt-2">Belum ada jawaban terisi untuk field ini.</p>`;
                return html;
            }

            const displayData = fieldData.data.slice(0, 10);
            
            html += `<ul class="space-y-2 max-h-60 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200">`;
            displayData.forEach(answer => {
                html += `<li class="p-2 border-b border-gray-100 last:border-b-0 text-gray-700 text-sm">${answer}</li>`;
            });
            html += `</ul>`;
            
            if (fieldData.data.length > 10) {
                 html += `<p class="text-xs text-gray-500 mt-2 italic">Menampilkan 10 jawaban teratas.</p>`;
            }
            
            return html;
        }
        
        function renderPieChartData(fieldData, totalResponses, index) {
            const canvasId = `chart-canvas-${index}`;
            
            let html = `<div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-4">`;
            html += `<div class="chart-container flex-shrink-0"><canvas id="${canvasId}"></canvas></div>`;

            html += `<div class="flex-grow w-full md:w-auto p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-3 text-sm">Pilihan:</h4>
                        <ul id="legend-${canvasId}" class="space-y-2">`;
            
            const sortedOptions = Object.entries(fieldData.data).sort((a, b) => b[1] - a[1]);
            
            if (Object.keys(fieldData.data).length === 0) {
                html += `<p class="text-gray-500 italic mt-2 text-sm">Belum ada jawaban.</p>`;
            } else {
                sortedOptions.forEach((entry, colorIndex) => {
                    const color = CHART_COLORS[colorIndex % CHART_COLORS.length];
                    html += `<li class="flex justify-between items-center text-xs">
                                <div class="flex items-center space-x-2">
                                    <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${color};"></span>
                                    <span class="text-gray-700">${entry[0]}</span>
                                </div>
                                <span class="font-bold text-gray-900">(${entry[1]})</span>
                            </li>`;
                });
            }

            html += `</ul></div></div>`;
            return html;
        }

        function drawPieChart(canvasId, fieldData, totalResponses) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(fieldData.data);
            const dataCounts = Object.values(fieldData.data);
            const dataColors = dataCounts.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);

            const newChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataCounts,
                        backgroundColor: dataColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Distribusi Jawaban (${fieldData.totalCount})`,
                            font: { size: 14 }
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                if (total === 0) return '';
                                return (value / total * 100).toFixed(1) + '%';
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 11 }
                        }
                    }
                }
            });
            activeCharts.push(newChart);
        }
        
        function renderCheckboxData(fieldData) {
            let html = `<p class="text-sm text-gray-600 mb-4">Total Responden Mengisi: <span class="font-semibold text-blue-600">${fieldData.totalCount}</span></p>`;
            
            if (Object.keys(fieldData.data).length === 0) {
                html += `<p class="text-gray-500 italic mt-2">Belum ada pilihan yang dipilih.</p>`;
                return html;
            }

            html += `<div class="overflow-x-auto p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/4">Pilihan</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Jumlah Pemilih</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;

            const sortedOptions = Object.entries(fieldData.data).sort((a, b) => b[1] - a[1]);

            sortedOptions.forEach(entry => {
                html += `<tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 w-3/4">${entry[0]}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-gray-900 text-right w-1/4">${entry[1]}</td>
                        </tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        // FUNGSI exportToExcel TETAP ADA DI JS UNTUK KOMPATIBILITAS (Meskipun tombol dihapus)
        function exportToExcel() {
            if (!formId || allResponses.length === 0) {
                alert('Tidak ada data respon untuk diekspor. Pilih formulir terlebih dahulu.');
                return;
            }
            window.open(`${API_BASE_URL}?action=export_excel&id=${formId}`, '_blank');
        }
    </script>
</body>
</html>